<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.56.3" />


<title>poorman: The Selectificator 2000! - Random R Ramblings</title>
<meta property="og:title" content="poorman: The Selectificator 2000! - Random R Ramblings">




  








<link href='//cdn.bootcss.com/highlight.js/9.11.0/styles/dracula.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/logo.JPG"
         width="50"
         height="50"
         alt="Logo">
  </a>

  <ul class="nav-links">
    
      <li><a href="https://github.com/nathaneastwood"><span class="inline-svg" ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></i></a></li>
    
      <li><a href="https://www.linkedin.com/in/nathaneastwood/"><span class="inline-svg" ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></i></a></li>
    
      <li><a href="https://stackoverflow.com/users/3759418/nathaneastwood"><span class="inline-svg" ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M290.7 311L95 269.7 86.8 309l195.7 41zm51-87L188.2 95.7l-25.5 30.8 153.5 128.3zm-31.2 39.7L129.2 179l-16.7 36.5L293.7 300zM262 32l-32 24 119.3 160.3 32-24zm20.5 328h-200v39.7h200zm39.7 80H42.7V320h-40v160h359.5V320h-40z"/></svg>
</span></i></a></li>
    
      <li><a href="https://twitter.com/nathaneastwood_"><span class="inline-svg" ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
</span></i></a></li>
    
      <li><a href="/about/"><span class="inline-svg" ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0 96 57.3 96 128s57.3 128 128 128zm95.8 32.6L272 480l-32-136 32-56h-96l32 56-32 136-47.8-191.4C56.9 292 0 350.3 0 422.4V464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48v-41.6c0-72.1-56.9-130.4-128.2-133.8z"/></svg>
</span></i></a></li>
    
  </ul>
  
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">8 min read</span>
    

    <h1 class="article-title">poorman: The Selectificator 2000!</h1>

    
    <span class="article-date">2020-05-17</span>
    

    <div class="article-content">
      
<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>Welcome to my series of blog posts about my data manipulation package, <code>{poorman}</code>. For those of you that don’t know, <code>{poorman}</code> is aiming to be a replication of <code>{dplyr}</code> but using only <code>{base}</code> R, and therefore be completely dependency free. What’s nice about this series is that if you’re not into <code>{poorman}</code> and would prefer just to use <code>{dplyr}</code>, then that’s absolutely OK! By highlighting <code>{poorman}</code> functionality, this series of blog posts simultaneously highlights <code>{dplyr}</code> functionality too! However I also describe how I developed the internals of <code>{poorman}</code>, often highlighting useful <code>{base}</code> R tips and tricks.</p>
<p>I recently released v0.2.0 of <code>{poorman}</code> which you can install from <a href="https://cran.r-project.org/web/packages/poorman/">CRAN</a> and so today I am going to talk about my progress in expanding the flexibility of the <code>select()</code> function. But I’m not just going to show you what it can do, I am going to show you how. If you’re interested in learning a little bit about non-standard evaluation in R then be sure to read on.</p>
</div>
<div id="the-selectificator-1000" class="section level1">
<h1>The Selectificator 1000</h1>
<p>Before v0.2.0, <code>{poorman}</code> was using a form of non-standard evaluation which converts function inputs to character strings and then uses those to figure out which columns to select. Specifically, <code>{poorman}</code> includes the following helper function.</p>
<pre class="r"><code>deparse_dots &lt;- function(...) {
  vapply(substitute(...()), deparse, NA_character_)
}</code></pre>
<p>This is an unexported function since it is not user facing but you can find it in the code on GitHub <a href="https://github.com/nathaneastwood/poorman/blob/master/R/utils.R#L1">here</a>. Let’s dig into what this function does a little, but first we will define a temporary function to show by example.</p>
<pre class="r"><code>dummy_select &lt;- function(...) {
  deparse_dots(...)
}</code></pre>
<p>Now of course in the real <code>select()</code> function, <code>select()</code> takes both data (passed to <code>.data</code>) and column names (passed to <code>...</code>) as inputs and then returns a subset of the data object containing only those columns. In our temporary function, we are just interested in the evaluation of the column names. So let’s try it out.</p>
<pre class="r"><code>dummy_select(x, y)
# [1] &quot;x&quot; &quot;y&quot;</code></pre>
<p>Here we passed two objects, <code>x</code> and <code>y</code> which are intended to represent our column names. These objects are in fact symbols which we would expect to be evaluated, but they weren’t; they are instead turned into character strings. This is thanks to the <code>deparse()</code> and <code>substitute()</code> combination. <code>deparse_dots()</code> first uses <code>substitute()</code> to return the unevaluated expression (in our case <code>...()</code>) and substitutes any variables bound in the environment (here <code>x</code> and <code>y</code>). <code>deparse_dots()</code> then loops over each of these inputs and deparses them. From the help page, <code>?deparse</code>:</p>
<blockquote>
<p>Turn unevaluated expressions into character strings.</p>
</blockquote>
<p>So now we have our function column inputs as character strings. This is a good start as we can now match on those character strings with the column names of our data (<code>match(deparse_dots(...), colnames(.data))</code>) to get the integer column positions of <code>x</code> and <code>y</code>. But what if the user inputs, for example, an integer?</p>
<pre class="r"><code>dummy_select(1, 3, 5)
# [1] &quot;1&quot; &quot;3&quot; &quot;5&quot;</code></pre>
<p>This now poses a problem. Does the user here mean that they want the first, third and fifth columns returned? Or do they mean that there are columns within their <code>data.frame</code> called “1”, “3” and “5” - which aren’t necessarily in the first, third and fifth positions - and those are the columns they would like? So the problem with this approach is that when everything is converted to characters, it is almost impossible to know whether the user input to the function is a column name, a column integer position or a function like a <a href="https://nathaneastwood.github.io/2020/04/13/poorman-select-helpers-bug-fixes-and-tests-tests-tests/">select helper</a>, with any degree of certainty. The function has to <code>try()</code> certain things by making certain assumptions and of course making an assumption makes…well, you’ve heard the saying.</p>
</div>
<div id="the-selectificator-2000" class="section level1">
<h1>The Selectificator 2000</h1>
<p>This is where the upgrades to the <code>poorman::select()</code> function come in. As a user I want to be able to pass integers, numerics, character strings, symbols and even functions to be interpreted by the <code>select()</code> function correctly and return the columns I desire. This is where the next line of code - which is absolutely brilliant - comes in.</p>
<pre class="r"><code>eval(substitute(alist(...)))</code></pre>
<p>Let’s break this function down and see what it does. We will work with a function and build it up bit by bit.</p>
<pre class="r"><code>dummy_select &lt;- function(...) {
  alist(...)
}
dummy_select(x, y)
# [[1]]
# ...</code></pre>
<p>Ok, not so exciting, right? What about if we wrap this in substitute?</p>
<pre class="r"><code>dummy_select &lt;- function(...) {
  substitute(alist(...))
}
dummy_select(x, y)
# alist(x, y)</code></pre>
<p>Now we can see that we have managed to pass in our inputs but they seem to be wrapped in an unevaluated call to <code>alist()</code>, so let’s try and evaluate it.</p>
<pre class="r"><code>dummy_select &lt;- function(...) {
  eval(substitute(alist(...)))
}
dummy_select(x, y)
# [[1]]
# x
# 
# [[2]]
# y</code></pre>
<p>Perfect! Now we have our unevaluated function inputs stored in a list. But what is so great about that? Well, let’s take a look at the structure of this output.</p>
<pre class="r"><code>str(dummy_select(x, y))
# List of 2
#  $ : symbol x
#  $ : symbol y</code></pre>
<p>So we can see that our inputs have been stored as their appropriate class; symbols! As a matter of fact, this occurs no matter what we use as our inputs.</p>
<pre class="r"><code>str(dummy_select(1L, 2, &quot;x&quot;, y, starts_with(&quot;R&quot;)))
# List of 5
#  $ : int 1
#  $ : num 2
#  $ : chr &quot;x&quot;
#  $ : symbol y
#  $ : language starts_with(&quot;R&quot;)</code></pre>
<p>This is fantastic. What this means is that we can now define functionality that can handle each of the separate types we typically expect being used in a call to <code>select()</code>. All of this magic is owed to the <code>alist()</code> function, let’s take a look at the documentation.</p>
<blockquote>
<p><code>alist</code> handles its arguments as if they described function arguments. So the values are not evaluated, and tagged arguments with no value are allowed whereas <code>list</code> simply ignores them.</p>
</blockquote>
<p>So if we had used the <code>list()</code> function, it would have attempted to evaluate our inputs to the <code>dummy_select()</code> function whereas <code>alist()</code> does not - it stores them as unevaluated objects.</p>
<p>Now, this starts to get really interesting when we start to take a look at the <code>language</code> inputs. When using <code>dplyr::select()</code>, the user is able to select columns in a number of ways. Let’s take a look at some of them and what the structure of those look like.</p>
<pre class="r"><code>str(dummy_select(!w, x:y, -z))
# List of 3
#  $ : language !w
#  $ : language x:y
#  $ : language -z</code></pre>
<p>So selecting columns through the use of an exclamation mark (negation), a colon or a minus sign actually gives us a <code>language</code> object. Ok, so what? What is so special about this? Well what makes this so useful to us is how we can interact with the objects. We can actually access parts of the <code>language</code> object, much in the same way we do with a <code>list()</code>. Let’s take a look.</p>
<pre class="r"><code>obj &lt;- dummy_select(x:y)
obj[[1]][1]
# `:`()</code></pre>
<p>So operators are actually functions. In fact, in R, everything is an object and we interact with those objects using functions, so this makes sense. Let’s look a bit deeper into this object.</p>
<pre class="r"><code>obj[[1]][[1]]
# `:`
obj[[1]][[2]]
# x
obj[[1]][[3]]
# y</code></pre>
<p>So our function input, <code>x:y</code>, can be broken down into it’s individual components. We know that the components are made up of the colon function as well as <code>x</code> and <code>y</code>, but what is the structure of these final two components?</p>
<pre class="r"><code>str(obj[[1]][[2]])
#  symbol x
str(obj[[1]][[3]])
#  symbol y</code></pre>
<p>They are symbols! So now we can handle these much in the same way as we did with the symbol inputs in the first instance, because remember, just passing <code>x</code> or <code>y</code> to our <code>dummy_select()</code> function returned a symbol.</p>
<pre class="r"><code>str(dummy_select(x, y))
# List of 2
#  $ : symbol x
#  $ : symbol y</code></pre>
<p>So there you have it! This is how you, as the user, are now able to perform <code>select()</code> calls with <code>{poorman}</code> like this:</p>
<pre class="r"><code>library(poorman, warn.conflicts = FALSE)
mtcars %&gt;%
  select(drat, mpg:hp, starts_with(&quot;g&quot;), everything()) %&gt;%
  head()
#                   drat  mpg cyl disp  hp gear    wt  qsec vs am carb
# Mazda RX4         3.90 21.0   6  160 110    4 2.620 16.46  0  1    4
# Mazda RX4 Wag     3.90 21.0   6  160 110    4 2.875 17.02  0  1    4
# Datsun 710        3.85 22.8   4  108  93    4 2.320 18.61  1  1    1
# Hornet 4 Drive    3.08 21.4   6  258 110    3 3.215 19.44  1  0    1
# Hornet Sportabout 3.15 18.7   8  360 175    3 3.440 17.02  0  0    2
# Valiant           2.76 18.1   6  225 105    3 3.460 20.22  1  0    1</code></pre>
</div>
<div id="conclusion" class="section level1">
<h1>Conclusion</h1>
<p>This post has taken a look at two separate non-standard evaluation approaches - using nothing but <code>{base}</code> - deployed within the <code>{poorman}</code> package. We have seen how to break down <code>language</code> objects to pick out key pieces of information from them. We also saw how to determine the object types of function inputs and why this is important to consider. In particular, this showed how I was able to transform the <code>select()</code> function into the omega selectificator function…of doom.</p>
<p>As this blog post is quite long, I haven’t gone into any further details of the internals of <code>{poorman}</code> however if you are interested in taking a closer look at how I handle the different input types, you can see the code on the relevant <code>{poorman}</code> <a href="https://github.com/nathaneastwood/poorman/blob/master/R/select_positions.R">GitHub page</a>. <code>{poorman}</code> is still a work in progress but as you can see, it already has a lot of functionality you know and love from <code>{dplyr}</code> so if you are working on a new project and don’t want to have to deal with dependency management, especially if you are sharing work with colleagues, why not give <code>{poorman}</code> a try?</p>
<p>If you’d like to show your support for <code>{poorman}</code>, please consider giving the package a <a href="https://github.com/nathaneastwood/poorman/stargazers">Star on Github</a> as it gives me that boost of dopamine needed to continue development.</p>
</div>

    </div>
  </article>

  

<section id="comments">
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  
  };
  (function() {
    var inIFrame = function() {
      var iframe = true;
      try { iframe = window.self !== window.top; } catch (e) {}
      return iframe;
    };
    if (inIFrame()) return;
    var d = document, s = d.createElement('script');
    s.src = '//nathaneastwood-github-io.disqus.com/embed.js'; s.async = true;
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>




</main>

      <footer class="footer">
    
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank"><span class="inline-svg" ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg>
</span></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="/js/math-code.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-87791665-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>

